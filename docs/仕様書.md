# 競輪データ取得システム仕様書

## 更新プロセス

競輪データの取得・更新は以下の5つのステップに分かれています。

### ステップ1：月間開催情報の取得

Winticketから月間の開催情報を取得し、以下のテーブルに保存します：
- regions：地域情報
- venues：競輪場情報
- cups：開催情報

#### 処理内容
1. 指定した年月の開催情報をWinticketのAPI（/cups）から取得
2. 取得したデータから地域情報、競輪場情報、開催情報を抽出
3. 各テーブルに保存

### ステップ2：開催詳細情報の取得

ステップ1で取得した開催IDをもとに、各開催の詳細情報を取得し、以下のテーブルに保存します：
- schedules：開催スケジュール情報
- races：レース情報

#### 処理内容
1. 開催IDごとに詳細情報をWinticketのAPIから取得
2. スケジュール情報とレース情報を抽出
3. 各テーブルに保存

### ステップ3：レース基本情報の取得

特定の開催における各レースの基本情報を取得します。

#### 処理内容
1. ステップ2で取得した開催IDごとにレース情報を取得
   - エンドポイント: `/cups/{cup_id}/schedules/{index}/races/{race_number}`
   - パラメータ:
     - cup_id: 開催ID
     - index: 開催日インデックス（開催日次に対応）
     - race_number: レース番号
   - 取得データ:
     - レース基本情報（ID、レース番号、レース名、開始時刻、距離、周回数など）
     - 環境情報（天候、気温、湿度、風速など）
     - レースステータス（予定、進行中、終了、中止など）
     - レースクラス、グレード情報
2. 各レースの出走表情報を取得
   - 車番、選手ID、級班、脚質、欠場情報など
   - 選手基本情報（名前、年齢、生年月日、所属、ランクなど）
3. 取得した情報をデータベースに保存
   - racesテーブルに基本情報を保存
   - race_entriesテーブルに出走表情報を保存
   - players情報が未登録の場合は新規に登録

### ステップ4：オッズ情報の取得

レースのオッズ情報を取得し、以下のテーブルに保存します：
- payouts_quinella：二車連オッズ情報
- payouts_exacta：二車単オッズ情報
- payouts_trio：三連複オッズ情報
- payouts_trifecta：三連単オッズ情報
- payouts_quinella_place：ワイドオッズ情報
- payouts_bracket_quinella：枠連オッズ情報
- payouts_bracket_exacta：枠単オッズ情報
- odds_stats：オッズ統計情報

#### 処理内容
1. レースIDごとにオッズ情報をWinticketのAPIから取得
   - エンドポイント: `/keirin/odds`
   - パラメータ:
     - cup_id: 開催ID
     - day: 開催日インデックス（開催日次に対応）
     - race: レース番号
   - 取得データ:
     - 各種オッズ情報（二車連、二車単、三連複、三連単、ワイド、枠連、枠単）
     - オッズ値、変動範囲（最小値・最大値）、人気順位
     - 最終オッズ確定状態（isFinal）
     - 払戻状態（payoutStatus）
     - オッズ最終更新時刻（updatedAt）
2. 取得した各種オッズ情報を券種ごとに対応するテーブルに保存
   - 二車連→payouts_quinellaのように各券種のテーブルに保存
   - オッズの変動範囲、人気順位、払戻金額などの詳細情報も保存
   - オッズ統計情報（確定状態、払戻状態、更新時刻）も記録

#### payouts_quinella（二車連オッズ情報）
- race_id: TEXT (PK) - レースID
- numbers: TEXT (PK) - 車番の組み合わせ（JSON配列形式、例：[1,2]）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_exacta（二車単オッズ情報）
- race_id: TEXT (PK) - レースID
- numbers: TEXT (PK) - 車番の組み合わせ（JSON配列形式、例：[1,2]）（1着→2着の順序あり）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_trio（三連複オッズ情報）
- race_id: TEXT (PK) - レースID
- numbers: TEXT (PK) - 車番の組み合わせ（JSON配列形式、例：[1,2,3]）（順序なし）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_trifecta（三連単オッズ情報）
- race_id: TEXT (PK) - レースID
- numbers: TEXT (PK) - 車番の組み合わせ（JSON配列形式、例：[1,2,3]）（1着→2着→3着の順序あり）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_quinella_place（ワイドオッズ情報）
- race_id: TEXT (PK) - レースID
- numbers: TEXT (PK) - 車番の組み合わせ（JSON配列形式、例：[1,2]）（2着以内に来る2車の組み合わせ）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_bracket_quinella（枠連オッズ情報）
- race_id: TEXT (PK) - レースID
- brackets: TEXT (PK) - 枠番号の組み合わせ（JSON配列形式、例：[1,2]）（順序なし）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### payouts_bracket_exacta（枠単オッズ情報）
- race_id: TEXT (PK) - レースID
- brackets: TEXT (PK) - 枠番号の組み合わせ（JSON配列形式、例：[1,2]）（1着→2着の順序あり）
- odds_value: REAL - オッズ値
- min_odds: REAL - 最小オッズ値（変動範囲下限）
- max_odds: REAL - 最大オッズ値（変動範囲上限）
- popularity_order: INTEGER - 人気順位
- unit_price: INTEGER - 単位金額（通常100円）
- payoff_price: INTEGER - 払戻金額
- is_absent: INTEGER - 欠場フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### odds_stats（オッズ統計情報）
- race_id: TEXT (PK) - レースID
- is_final: INTEGER - 最終オッズフラグ
- payout_status: INTEGER - 払戻状態（0: 未払い、1: 払い戻し中、2: 払い戻し完了）
- updated_at: INTEGER - オッズ更新時刻（Unix時間）
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

### ステップ5：レース結果とラップデータの取得

指定したレースのレース結果、レース概要、選手成績情報などを取得します。

#### 処理内容
1. レースIDごとにレース結果をWinticketのAPIから取得
   - エンドポイント: `/cups/{cup_id}/schedules/{index}/races/{race_number}`
   - パラメータ:
     - cup_id: 開催ID
     - index: 開催日インデックス（開催日次に対応）
     - race_number: レース番号
   - 取得データ:
     - レース基本情報（レース名、開始時刻、距離、周回数、天候、気温、風速など）
     - 出走表情報（車番、選手ID、級班、脚質、欠場情報など）
     - 選手情報（名前、年齢、生年月日、所属、級班、標準ギアなど）
     - レース結果情報（着順、タイム、使用ギア比、使用脚質、レースコメントなど）
     - レース展開要約情報（レースダイジェストテキスト）
2. 取得したレース結果情報をデータベースに保存
   - race_resultsテーブルに着順、タイム、ギア比などの基本結果を保存
   - race_summariesテーブルにレース展開の要約情報を保存
   - race_lap_timesテーブルに周回ごとのラップタイム情報を保存（利用可能な場合）
   - player_race_statsテーブルに選手ごとのレース統計情報を保存
3. レース結果と関連する統計情報を更新
   - 選手の通算成績、コース別成績、級班別成績などの更新
   - レースグレード、天候条件などの分析情報の更新

## データベース設計

### レースステータス
- 0: 未出走
- 1: 発走30分前
- 2: 投票締め切り
- 3: レース確定 

### テーブル構造

#### regions（地域情報）
- region_id: TEXT (PK) - 地域ID
- region_name: TEXT - 地域名
- region_code: TEXT - 地域コード
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### venues（競輪場情報）
- venue_id: TEXT (PK) - 競輪場ID
- venue_name: TEXT - 競輪場名
- venue_short_name: TEXT - 競輪場の略称
- region_id: TEXT (FK) - 所属地域ID
- address: TEXT - 住所
- phone_number: TEXT - 電話番号
- track_distance: INTEGER - トラック距離（m）
- bank_feature: TEXT - バンク特性
- best_record_player_id: TEXT - 最高記録保持選手ID
- best_record_second: REAL - 最高記録（秒）
- best_record_date: TEXT - 最高記録達成日
- latitude: REAL - 緯度
- longitude: REAL - 経度
- url: TEXT - 公式URL
- active: INTEGER - アクティブフラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### cups（開催情報）
- cup_id: TEXT (PK) - 開催ID
- cup_name: TEXT - 開催名
- start_date: TEXT - 開始日
- end_date: TEXT - 終了日
- duration: INTEGER - 開催日数
- grade: INTEGER - グレード（1:F2, 2:F1, 3:G3, 4:G2, 5:G1）
- venue_id: TEXT (FK) - 競輪場ID
- labels: TEXT - ラベル（カンマ区切り）
- players_unfixed: INTEGER - 選手未確定フラグ
- cup_code: TEXT - 開催コード
- cup_class: TEXT - 開催クラス
- status: TEXT - 開催ステータス
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### schedules（スケジュール情報）
- schedule_id: TEXT (PK) - スケジュールID
- date: TEXT - 開催日
- day: INTEGER - 開催日次
- cup_id: TEXT (FK) - 開催ID
- index: INTEGER - インデックス
- entries_unfixed: INTEGER - エントリー未確定フラグ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### races（レース情報）
- id: INTEGER PRIMARY KEY - レースID
- cup_id: TEXT - 開催ID（cupsテーブルの外部キー）
- schedule_id: TEXT - スケジュールID
- number: INTEGER - レース番号
- name: TEXT - レース名
- start_at: TIMESTAMP - 発走時刻
- distance: INTEGER - 距離（メートル）
- lap: INTEGER - 周回数
- bike_count: INTEGER - 出走台数
- grade: INTEGER - グレード
- condition: TEXT - コンディション
- temperature: FLOAT - 気温
- humidity: INTEGER - 湿度
- weather: TEXT - 天候
- wind_speed: FLOAT - 風速
- status: TEXT - レースステータス
- cancel: INTEGER - 中止フラグ
- cancel_reason: TEXT - 中止理由
- class: TEXT - レースクラス
- close_at: TIMESTAMP - 締切時刻
- decided_at: TIMESTAMP - 確定時刻
- race_type: TEXT - レース種別
- is_grade_race: INTEGER - グレードレースフラグ
- has_digest_video: INTEGER - ダイジェスト動画有無
- digest_video: TEXT - ダイジェスト動画URL
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### entries（出走表）
- entry_id: TEXT (PK) - エントリーID
- race_id: TEXT (FK) - レースID
- rider_id: TEXT - 選手ID
- rider_name: TEXT - 選手名
- frame_num: INTEGER - 枠番
- rank: INTEGER - 順位
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### race_results（レース結果）
- id: INTEGER PRIMARY KEY - レース結果ID
- race_id: INTEGER - レースID（racesテーブルの外部キー）
- player_id: INTEGER - 選手ID（playersテーブルの外部キー）
- car_number: INTEGER - 車番
- rank: INTEGER - 着順
- time: FLOAT - 走破タイム（秒）
- gear_ratio: FLOAT - 使用ギア比
- style: TEXT - 使用脚質（例: "逃げ", "差し"）
- race_point: INTEGER - レースポイント
- comment: TEXT - レースコメント
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### rider_positions（選手位置情報）
- race_id: TEXT (PK) - レースID
- rider_id: TEXT (PK) - 選手ID
- lap: INTEGER (PK) - 周回数
- position: INTEGER - 位置（順位）
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### race_summaries（レース展開の説明）
- id: INTEGER PRIMARY KEY - サマリーID
- race_id: INTEGER - レースID（racesテーブルの外部キー）
- digest_type: INTEGER - ダイジェストタイプ
- title: TEXT - タイトル
- content: TEXT - レース展開の説明内容
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### inspection_reports（検車場レポート）
- race_id: TEXT (PK) - レースID
- rider_id: TEXT (PK) - 選手ID
- rider_info: TEXT - 選手情報（名前、府県、期別など）
- photo_url: TEXT - 選手写真URL
- comment: TEXT - 選手コメント
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

#### lap_data_status（周回データ状態）
- race_id: TEXT (PK) - レースID
- has_lap_data: INTEGER - 周回データ有無
- position_data_available: INTEGER - 位置情報有無
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

### race_lap_times（周回ごとのラップタイム）
- id: INTEGER PRIMARY KEY - ラップタイムID
- race_id: INTEGER - レースID（racesテーブルの外部キー）
- lap_number: INTEGER - 周回番号
- time: FLOAT - ラップタイム（秒）
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

### player_race_stats（選手レース統計）
- id: INTEGER PRIMARY KEY - 統計ID
- race_id: INTEGER - レースID（racesテーブルの外部キー）
- player_id: INTEGER - 選手ID（playersテーブルの外部キー）
- first_rate: FLOAT - 1着率
- second_rate: FLOAT - 2着率
- third_rate: FLOAT - 3着率
- first_count: INTEGER - 1着回数
- second_count: INTEGER - 2着回数
- third_count: INTEGER - 3着回数
- other_count: INTEGER - その他着順回数
- style_stats: TEXT - 脚質統計情報（JSON形式）
- line_stats: TEXT - ライン別統計情報（JSON形式）
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

### race_entries（出走表情報）
- id: INTEGER PRIMARY KEY - 出走表ID
- race_id: INTEGER - レースID（racesテーブルの外部キー）
- player_id: INTEGER - 選手ID（playersテーブルの外部キー）
- number: INTEGER - 車番
- class: INTEGER - 選手クラス
- style: INTEGER - 脚質番号
- style_point: INTEGER - 脚質指数
- absent: INTEGER - 欠場フラグ
- bracket_number: INTEGER - 枠番号
- player_current_term_class: TEXT - 当期選手級班
- player_current_term_group: TEXT - 当期選手グループ
- player_previous_term_class: TEXT - 前期選手級班
- player_previous_term_group: TEXT - 前期選手グループ
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

### players（選手情報）
- id: INTEGER PRIMARY KEY - 選手ID
- name: TEXT - 選手名
- name_short: TEXT - 選手名（短縮版）
- name_kana: TEXT - 選手名カナ
- name_5: TEXT - 選手名（5文字）
- yomi: TEXT - 選手名読み
- age: INTEGER - 年齢
- birthday: TEXT - 生年月日
- prefecture: TEXT - 所属（都道府県）
- rank: INTEGER - 選手ランク
- gear: FLOAT - 標準ギア
- class: TEXT - 選手級班
- gender: TEXT - 性別
- group: TEXT - 選手グループ
- portrait_image: TEXT - 選手画像URL
- region_id: TEXT - 地域ID
- term: INTEGER - 期
- created_at: TIMESTAMP - 作成日時
- updated_at: TIMESTAMP - 更新日時

## API仕様

### Winticket API

#### 月間開催情報 (/cups)
- 引数：date（YYYYMMDD形式）
- 取得データ：
  - 開催一覧（ID、名称、開始日、終了日、期間、グレード、会場ID、ラベル情報）
  - 地域情報（ID、名称、コード）
  - 競輪場情報（ID、名称、短縮名、地域ID、住所、電話番号、トラック情報）

#### 開催詳細情報 (/cups/{cup_id})
- 引数：cup_id（開催ID）
- 取得データ：
  - 開催詳細（ID、名称、開始日、終了日、期間、グレード、会場ID、ラベル情報）
  - スケジュール情報（ID、日付、日次、開催ID、インデックス、出走表確定状態）
  - レース一覧（ID、番号、名称、開始時刻、開催ID、スケジュールID、距離、周回数、
    出走数、クラス、レース種別、グレード情報、ステータス、天候、風速、中止情報、
    締切・確定時刻、ダイジェスト動画情報）

#### レース情報 (/cups/{cup_id}/schedules/{index}/races/{race_number})
- 引数：
  - cup_id（開催ID）
  - index（スケジュールインデックス） 
  - race_number（レース番号）
- 取得データ：
  - レース詳細（ID、番号、名前、開始時刻、距離、周回数、コンディション、気温、湿度、
    天候、風速、ステータス、クラス、締切・確定時刻、出走数、レース種別、勝者情報）
  - 出走表（ID、車番、選手ID、クラス、脚質、脚質指数、欠場情報、枠番号、級班情報）
  - 選手情報（ID、名前、年齢、生年月日、所属、ランク、標準ギア、級班、性別、グループ、画像）
  - 選手成績（着順、タイム、使用ギア比、使用脚質、レースポイント、コメント、
    1-3着率、マーカー情報、各種走法統計データ、最近の成績）
  - ライン予想情報
  - レース要約情報

#### オッズ情報 (/cups/{cup_id}/schedules/{index}/races/{race_number}/odds)
- 引数：
  - cup_id（開催ID）
  - index（スケジュールインデックス）
  - race_number（レース番号）
- 取得データ：
  - 単勝オッズ（車番、オッズ値、変動範囲、人気順位、払戻金額）
  - 複勝オッズ
  - 枠連オッズ
  - 枠単オッズ
  - 二車連オッズ
  - 二車単オッズ
  - 三連複オッズ
  - 三連単オッズ
  - ワイド（二車複）オッズ
  - 人気順位情報
  - オッズ更新時刻・最終確定状態・払戻状態

### Yenjoy API

#### レース結果詳細ページ
- URL形式：`/kaisai/race/result/detail/{year_month}/{venue_code}/{start_date}/{race_date}/{race_number}`
- 引数：
  - year_month（YYYYMM形式）：年月
  - venue_code（数値）：競輪場コード（例：45=豊橋）
  - start_date（YYYYMMDD形式）：開催初日
  - race_date（YYYYMMDD形式）：レース開催日
  - race_number（数値）：レース番号
- 取得データ：
  - レース基本情報（開催日、日次、レース番号、クラス、天候、風速）
  - レース結果詳細
    - 着順、車番、印（◎○△など）、選手名、年齢、府県、期別、級班
    - 着差、上り、決まり手、S/JH/Bなどの記号、勝敗因、個人状況、直近成績
  - 払戻金情報
    - 各種式別（単勝、複勝、2連単、2連複、3連単、3連複）の車番組合せ、払戻金額、人気順
    - 発売票数、発売金額
    - レース展開の説明文（例：「古性が３番手確保し強襲。深谷は番手はまる新山合わせ逃げ粘る」）
  - 周回時の選手位置情報（各周回での順位）
  - 検車場レポート
    - 選手情報（名前、府県、期別）
    - 選手写真URL
    - 選手コメント（特に上位選手のレース分析・戦略コメント） 