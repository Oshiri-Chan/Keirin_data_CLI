# 競輪データ取得システム 仕様書・設計書

## 1. システム概要

### 1.1 目的
本システムは、競輪レース情報を定期的に自動取得し、データベースに保存・管理するための常駐型プログラムです。WinticketとYenjoyの2つの情報源からデータを取得し、一元管理することで競輪レース分析の基盤を提供します。

### 1.2 背景
競輪レースの結果や予想情報は複数のサイトに分散しており、これらの情報を手動で収集・分析することは非効率です。本システムはこの問題を解決するため、自動的にデータを収集し、分析可能な形式で保存します。

### 1.3 システム構成
- バックエンドプログラム: Python 3.x
- データベース: MySQL
- 動作環境: Windows（サービス機能あり）、Linux/macOS（デーモンとして動作）

## 2. 機能要件

### 2.1 基本機能
1. **データ取得機能**
   - Winticketサイトからの競輪データ取得
   - Yenjoyサイトからの競輪データ取得
   - 日付指定による過去データの取得

2. **定期実行機能**
   - スケジュールに基づく自動データ取得
   - 設定可能な更新間隔
   - 即時実行オプション

3. **データ管理機能**
   - MySQLデータベースへの保存
   - トランザクション管理
   - データ整合性の確保

4. **エラー処理機能**
   - 通信エラーの検出と再試行
   - 期間を指定した再試行
   - 失敗したタスクの記録と管理

### 2.2 実行モード
1. **デーモンモード**
   - バックグラウンドで常駐実行
   - 設定ファイルに基づく動作
   - シグナル対応による制御

2. **Windowsサービスモード**
   - Windowsサービスとしての登録・実行
   - サービス起動・停止時の適切な処理
   - イベントログへの記録

3. **コマンドラインモード**
   - 単一日付の即時更新
   - 日付範囲の一括更新
   - 設定変更・確認

## 3. 非機能要件

### 3.1 性能要件
1. **応答性**
   - APIリクエスト間の適切な待機時間（レート制限対応）
   - 大量データ処理時のメモリ管理

2. **信頼性**
   - エラー発生時の自動再試行
   - データ整合性の保証
   - 障害からの回復機能

3. **拡張性**
   - 新しいデータソースの追加が容易な設計
   - 設定ファイルによるカスタマイズ
   - モジュール化された構造

### 3.2 運用要件
1. **監視機能**
   - 詳細なログ出力
   - エラー通知
   - メモリ使用量の監視

2. **保守性**
   - 設定の動的変更
   - コンポーネントの独立性
   - 詳細なドキュメント

## 4. システムアーキテクチャ

### 4.1 全体構造
本システムは以下の主要コンポーネントで構成されています：

```
競輪データ取得システム
├── コアモジュール
│   ├── KeirinDataDaemon（メインデーモン）
│   ├── KeirinDatabase（データベース管理）
│   └── 各種ユーティリティ
├── API接続モジュール
│   ├── Winticketデータ取得
│   ├── Yenjoyデータ取得
│   └── APIレート制限・バックオフ
├── Windowsサービスモジュール
└── 設定管理モジュール
```

### 4.2 データフロー
1. スケジューラが定期的に更新処理をトリガー
2. データ更新ジョブがキューに登録
3. ワーカースレッドがキューからジョブを取得・実行
4. APIから対象日付のデータを取得
5. 取得したデータをデータベースに保存
6. 処理結果をログに記録

### 4.3 スレッドモデル
1. **メインスレッド**: ユーザー操作やシグナル処理
2. **スケジューラスレッド**: 定期実行の管理
3. **ワーカースレッド**: 実際のデータ取得・保存処理

## 5. モジュール詳細設計

### 5.1 KeirinDataDaemon クラス
メインデーモンクラスとして、全体の制御と管理を担当します。

#### 主要属性
- `config`: 設定オブジェクト
- `db_path`: データベースファイルパス
- `running`: 実行状態フラグ
- `job_queue`: ジョブキュー
- `last_update_time`: 最終更新時間
- `_failed_updates`: 失敗した更新のリスト

#### 主要メソッド
- `__init__()`: 初期化処理
- `start()`: デーモン開始
- `stop()`: デーモン停止
- `update_now()`: 即時更新
- `_update_data()`: データ更新処理
- `_update_single_date()`: 単一日付の更新
- `_update_date_range()`: 日付範囲の更新
- `_execute_retry()`: 失敗した更新の再試行
- `_schedule_update()`: 更新スケジュールの設定
- `get_memory_usage()`: メモリ使用量の取得
- `check_memory_usage()`: メモリ使用量の監視

### 5.2 Windowsサービス機能
Windowsサービスとして動作させるための機能を提供します。

#### KeirinService クラス
- `SvcDoRun()`: サービス実行時の処理
- `SvcStop()`: サービス停止時の処理

#### サービス管理機能
- `create_windows_service()`: サービスクラスの生成
- Windowsサービス登録・制御のサポート

### 5.3 API連携モジュール
外部APIと連携してデータを取得する機能を提供します。

#### update_winticket_data 関数
- Winticketサイトからのデータ取得・保存

#### update_yenjoy_data 関数
- Yenjoyサイトからのデータ取得・保存

#### ApiRateLimiter クラス
- API呼び出しの制限管理
- 適切な待機時間の計算

#### ApiBackoff クラス
- リトライ時の待機時間計算
- 指数バックオフアルゴリズム実装

### 5.4 設定管理
システム設定の管理を担当します。

#### get_config 関数
- 設定ファイルの読み込み
- デフォルト値の提供
- 設定値の検証

## 6. データモデル

### 6.1 データベース構造
MySQLデータベースを使用し、以下のテーブルを持ちます：

1. **Races**: レース基本情報
   - race_id: レースID (PK)
   - date: 開催日
   - venue: 開催場所
   - race_number: レース番号
   - race_name: レース名
   - race_type: レース種別

2. **Results**: レース結果
   - result_id: 結果ID (PK)
   - race_id: レースID (FK)
   - rank: 着順
   - player_id: 選手ID
   - time: タイム

3. **Odds**: オッズ情報
   - odds_id: オッズID (PK)
   - race_id: レースID (FK)
   - bet_type: 賭け方
   - combination: 組み合わせ
   - odds: オッズ値

4. **Updates**: 更新履歴
   - update_id: 更新ID (PK)
   - date: 更新対象日
   - source: データソース
   - update_time: 更新日時
   - status: 更新状態

### 6.2 ファイル構造
```
keirin_data/
├── scripts/
│   ├── keirin_data_daemon.py  # メインデーモン
│   ├── update_winticket_data.py  # Winticketデータ更新
│   ├── update_yenjoy_data.py  # Yenjoyデータ更新
│   ├── keirin_db.py  # データベース操作
│   ├── keirin_config.py  # 設定管理
│   └── api_rate_limiter.py  # API制限管理
├── keirin_config.ini  # 設定ファイル
├── keirin_data.mysql  # MySQLデータベース
└── logs/  # ログファイル格納ディレクトリ
```

## 7. エラーハンドリング

### 7.1 エラー種別
1. **通信エラー**: API接続時の問題
2. **データ不整合**: レスポンスが不正・不完全
3. **リソースエラー**: ディスク容量・メモリ不足など
4. **権限エラー**: ファイルアクセス権限の問題

### 7.2 エラー処理戦略
1. **再試行可能エラー**
   - 通信障害や一時的なAPIエラー
   - 設定された回数まで自動再試行
   - 指数バックオフ戦略によるウェイト時間の増加

2. **致命的エラー**
   - システム停止が必要なエラー
   - 詳細なログ記録
   - 管理者への通知

3. **データエラー**
   - 不正・不完全なデータ
   - エラーフラグと共に保存
   - 次回更新での再取得

### 7.3 リカバリー機能
- 失敗した更新のキュー管理
- 定期的な再試行スケジュール
- 最大再試行回数の設定

## 8. セキュリティ

### 8.1 データ保護
- ローカルデータベース使用によるアクセス制限
- 適切なファイルアクセス権限設定

### 8.2 通信セキュリティ
- HTTPS通信の使用
- APIキー・認証情報の適切な管理

## 9. 拡張性と保守性

### 9.1 拡張ポイント
1. **新しいデータソースの追加**
   - 標準化されたインターフェース
   - 設定ファイルでの有効化

2. **新しい分析機能の追加**
   - イベント通知の利用
   - データアクセスAPIの提供

### 9.2 設定管理
- INIファイル形式の設定
- 実行時の設定変更サポート
- コマンドライン引数によるオーバーライド

## 10. 運用ガイドライン

### 10.1 インストール
1. 必要パッケージのインストール
   ```
   pip install schedule psutil pywin32
   ```

2. 設定ファイルの準備
   ```
   keirin_config.ini を適切に設定
   ```

3. Windowsサービスとして登録（オプション）
   ```
   python scripts/keirin_data_daemon.py --service install
   ```

### 10.2 起動と停止
- **通常モード**
  ```
  python scripts/keirin_data_daemon.py
  ```

- **Windowsサービス**
  ```
  net start KeirinDataService
  net stop KeirinDataService
  ```

### 10.3 設定項目
- **[DAEMON]**
  - `update_interval`: 更新間隔（時間）
  - `check_interval`: チェック間隔（分）
  - `retry_interval`: 再試行間隔（分）
  - `start_time`: 毎日の更新開始時刻（HH:MM形式）
  - `run_initial_update`: 起動時に更新するか（true/false）

- **[UPDATE]**
  - `days_to_update`: 更新する過去の日数
  - `get_all_date`: 全期間更新モード（true/false）
  - `start_date`: 更新開始日
  - `end_date`: 更新終了日

- **[API]**
  - `winticket_url`: Winticket API URL
  - `yenjoy_url`: Yenjoy API URL
  - `request_timeout`: リクエストタイムアウト（秒）

- **[DATABASE]**
  - `path`: データベースファイルパス

- **[LOGGING]**
  - `level`: ログレベル（DEBUG/INFO/WARNING/ERROR）

- **[MEMORY]**
  - `warning_threshold_mb`: 警告閾値（MB）
  - `gc_threshold_mb`: ガベージコレクション閾値（MB）

### 10.4 コマンドラインオプション
- `--db`: データベースファイルのパス
- `--interval`: 更新間隔（時間）
- `--check`: チェック間隔（分）
- `--retry`: 再試行間隔（分）
- `--update-now`: 指定日付のデータを即時更新
- `--update-range`: 日付範囲の更新
- `--start-date`: 更新開始日
- `--end-date`: 更新終了日
- `--service`: Windowsサービス関連コマンド
- `--config`: 設定ファイルのパス
- `--log-level`: ログレベル

## 11. 制限事項と今後の拡張

### 11.1 現在の制限
- MySQLの同時アクセス制限
- API呼び出し頻度の制限
- 長期間の大量データ処理時のメモリ使用量

### 11.2 将来的な拡張
- WebUIによる監視・管理機能
- 分析・可視化機能の強化
- バックアップ・リストア機能の強化
- 並列処理による高速化
- 複数の競合情報源の統合的分析

---

## 付録

### A. エラーコード一覧
- E001: 設定ファイルエラー
- E002: データベース接続エラー
- E003: API通信エラー
- E004: データ解析エラー
- E005: リソース不足エラー

### B. 依存パッケージ
- schedule: ジョブスケジューリング
- psutil: システムリソースモニタリング
- pywin32: Windowsサービス機能（Windows環境のみ）
- requests: HTTPリクエスト
- mysql-connector-python: MySQLデータベース接続

### C. 変更履歴
- V1.0.0: 初期リリース
- V1.1.0: 再試行メカニズムの改善
- V1.2.0: メモリ監視機能の追加
- V1.3.0: Windowsサービス機能の強化
- V1.4.0: エラーハンドリングの強化
- V1.5.0: 日付範囲処理の最適化 